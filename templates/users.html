{% extends "base.html" %}
{% from '_pagination.html' import render_pagination %}
{% block title %}Danh sách Người Dùng{% endblock %}
{% block content %}
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="card-title mb-0">Danh sách Người Dùng</h2>
            <div>
                <a href="{{ url_for('add_user') }}" class="btn btn-primary"><i class="bi bi-person-plus"></i> Thêm người
                    dùng</a>
                {% if current_user.role == 'admin' %}
                <a href="{{ url_for('import_users') }}" class="btn btn-info ms-2"><i class="bi bi-upload"></i> Nhập
                    Excel</a>
                <a href="{{ url_for('export_users_excel') }}" class="btn btn-success ms-2"><i
                        class="bi bi-download"></i> Xuất Excel</a>
                {% endif %}
            </div>
        </div>
        <hr>
        <form method="GET" class="mt-3" id="user-filter-form">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Tên hoặc Tên đăng nhập</label>
                    <input type="text" name="filter_username" class="form-control" placeholder="Tìm kiếm..."
                        value="{{ filter_username }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Phòng ban</label>
                    <select name="filter_department" class="form-select">
                        <option value="">-- Tất cả --</option>
                        {% for dept in departments %}
                        <option value="{{ dept }}" {% if filter_department==dept %}selected{% endif %}>{{ dept }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Chức vụ</label>
                    <select name="filter_position" class="form-select">
                        <option value="">-- Tất cả --</option>
                        {% for pos in positions %}
                        <option value="{{ pos }}" {% if filter_position==pos %}selected{% endif %}>{{ pos }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Trạng thái</label>
                    <div class="d-flex gap-2">
                        <select name="filter_status" class="form-select">
                            <option value="">-- Tất cả --</option>
                            {% for status in statuses %}
                            <option value="{{ status }}" {% if filter_status==status %}selected{% endif %}>{{ status }}
                            </option>
                            {% endfor %}
                        </select>
                        <button formaction="{{ url_for('set_users_default_status') }}" formmethod="POST" name="status"
                            value="{{ filter_status }}" class="btn btn-outline-secondary" title="Lưu làm mặc định">
                            <i class="bi bi-bookmark-check"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <button type="submit" class="btn btn-primary flex-fill">Tìm kiếm</button>
                    <a href="{{ url_for('user_list') }}" class="btn btn-secondary flex-fill">Reset</a>
                </div>
            </div>
        </form>
        <div class="table-responsive">
            <table class="table table-striped table-hover mt-3">
                <thead class="table-light">
                    <tr>
                        <th>STT</th>
                        <th>Họ và tên</th>
                        <th>Tên đăng nhập</th>
                        <th>Phòng ban</th>
                        <th>Chức vụ</th>
                        <th>Trạng thái</th>
                        <th class="text-center">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users.items %}
                    <tr>
                        <td>{{ users.first + loop.index - 1 }}</td>
                        <td><strong>{{ user.full_name or '' }}</strong></td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.department_info.name if user.department_info else '' }}</td>
                        <td>{{ user.position or '' }}</td>
                        <td>
                            {% if user.status == 'Đang làm' %}<span class="badge bg-success">{{ user.status }}</span>
                            {% elif user.status == 'Thử việc' %}<span class="badge bg-info">{{ user.status }}</span>
                            {% elif user.status == 'Đã nghỉ' %}<span class="badge bg-secondary">{{ user.status }}</span>
                            {% else %}<span class="badge bg-warning text-dark">{{ user.status }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center text-nowrap">
                            <a href="{{ url_for('user_detail', user_id=user.id) }}" class="btn btn-sm btn-outline-info"
                                title="Xem"><i class="bi bi-eye"></i></a>
                            {% if current_permissions and 'users.edit' in current_permissions %}
                            <a href="{{ url_for('edit_user', user_id=user.id) }}"
                                class="btn btn-sm btn-outline-warning ms-1" title="Sửa"><i class="bi bi-pencil"></i></a>
                            <button type="button" class="btn btn-sm btn-outline-info ms-1 reset-password-btn"
                                title="Reset mật khẩu" data-user-id="{{ user.id }}" data-username="{{ user.username }}">
                                <i class="bi bi-key"></i>
                            </button>
                            {% endif %}
                            {% if current_permissions and 'users.delete' in current_permissions %}
                            <form method="POST" action="{{ url_for('delete_user', user_id=user.id) }}"
                                onsubmit="return confirm('Bạn chắc chắn muốn xóa người dùng này?')" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-danger ms-1" title="Xóa"><i
                                        class="bi bi-trash"></i></button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% set filters = {'filter_username': filter_username, 'filter_department': filter_department, 'filter_position':
        filter_position, 'filter_status': filter_status} %}
        {{ render_pagination(users, 'user_list', filters) }}
    </div>
</div>

<!-- Confirm Reset Modal -->
<div class="modal fade" id="confirmResetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận reset mật khẩu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn reset mật khẩu cho người dùng này?</p>
                <p class="text-danger"><small>Mật khẩu sẽ được tạo mới tự động.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmResetBtn">Reset ngay</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="resetSuccessModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Reset mật khẩu thành công</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Đã reset mật khẩu cho <strong id="resetSuccessUser"></strong> về:</p>
                <h3 class="text-center text-primary my-3 user-select-all" id="resetSuccessPass"></h3>
                <p class="text-muted small">Hãy copy mật khẩu này và gửi cho người dùng.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK, Đã copy</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
{{ super() }}
<script>
    // Submit search on Enter from the text field only
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('user-filter-form');
        const textInput = form.querySelector('input[name="filter_username"]');
        textInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                form.submit();
            }
        });
    });


    // Reset Password Logic
    let selectedUserId = null;
    let selectedUserName = null;
    let confirmModal = null;
    let successModal = null;

    // Initialize modals and event listeners after DOM is loaded
    document.addEventListener('DOMContentLoaded', function () {
        const confirmModalEl = document.getElementById('confirmResetModal');
        const successModalEl = document.getElementById('resetSuccessModal');

        if (confirmModalEl && typeof bootstrap !== 'undefined') {
            confirmModal = new bootstrap.Modal(confirmModalEl);
        }
        if (successModalEl && typeof bootstrap !== 'undefined') {
            successModal = new bootstrap.Modal(successModalEl);
        }

        // Event delegation for reset buttons
        document.body.addEventListener('click', function (e) {
            const btn = e.target.closest('.reset-password-btn');
            if (btn) {
                selectedUserId = btn.dataset.userId;
                selectedUserName = btn.dataset.username;
                if (confirmModal) {
                    confirmModal.show();
                } else {
                    alert('Lỗi: Không thể khởi tạo Modal (thư viện Bootstrap chưa tải xong?)');
                }
            }
        });

        // Confirm button handler
        const confirmBtn = document.getElementById('confirmResetBtn');
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function () {
                if (confirmModal) confirmModal.hide();
                if (!selectedUserId) return;

                fetch(`/users/${selectedUserId}/reset_password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            const userSpan = document.getElementById('resetSuccessUser');
                            const passH3 = document.getElementById('resetSuccessPass');
                            if (userSpan) userSpan.textContent = selectedUserName;
                            if (passH3) passH3.textContent = data.new_password;
                            if (successModal) successModal.show();
                        } else {
                            alert('Lỗi: ' + (data.message || 'Không xác định'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra khi reset mật khẩu: ' + error.message);
                    });
            });
        }
    });
</script>
{% endblock %}
{% endblock %}