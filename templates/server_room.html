{% extends "base.html" %}

{% block title %}Phòng server{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="card-title mb-0">Quản lý thiết bị Phòng server</h2>
            <a href="{{ url_for('device_groups') }}" class="btn btn-secondary">Nhóm thiết bị</a>
        </div>

        <form method="POST" class="mb-3">
            <label class="form-label">Thêm thiết bị từ kho vào Phòng server</label>
            <div class="row g-2 mb-2">
                <div class="col-md-4"><input type="text" class="form-control" id="filter_code" placeholder="Lọc mã thiết bị"></div>
                <div class="col-md-4"><input type="text" class="form-control" id="filter_name" placeholder="Lọc tên thiết bị"></div>
                <div class="col-md-4">
                    <select class="form-select" id="filter_type">
                        <option value="">-- Loại thiết bị --</option>
                        <option value="Laptop">Laptop</option>
                        <option value="Case máy tính">Case máy tính</option>
                        <option value="Màn hình">Màn hình</option>
                        <option value="Bàn phím">Bàn phím</option>
                        <option value="Chuột">Chuột</option>
                        <option value="Ổ cứng">Ổ cứng</option>
                        <option value="Ram">Ram</option>
                        <option value="Card màn hình">Card màn hình</option>
                        <option value="Máy in">Máy in</option>
                        <option value="Thiết bị mạng">Thiết bị mạng</option>
                        <option value="Server">Server</option>
                        <option value="Thiết bị khác">Thiết bị khác</option>
                    </select>
                </div>
            </div>
            <select name="device_ids" id="devices_select" multiple class="form-select" size="8">
                {% for device in devices_available %}
                <option value="{{ device.id }}" data-code="{{ device.device_code }}" data-name="{{ device.name }}" data-type="{{ device.device_type }}">{{ device.device_code }} - {{ device.name }} ({{ device.device_type }})</option>
                {% endfor %}
            </select>
            <div class="mt-2 text-end">
                <button class="btn btn-primary">Thêm vào phòng server</button>
            </div>
            <small class="text-muted">Thiết bị đã thuộc nhóm khác sẽ không hiển thị. Mỗi thiết bị chỉ thuộc một nhóm.</small>
        </form>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-light">
                    <tr>
                        <th>STT</th>
                        <th>Tên thiết bị</th>
                        <th>Mã thiết bị</th>
                        <th>Cấu hình</th>
                        <th>Ngày cập nhật</th>
                        <th>Người quản lý</th>
                        <th>Trạng thái</th>
                        <th>Chạy dịch vụ</th>
                        <th>IP</th>
                        <th>Ghi chú</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in devices_in_server %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ d.name }}</td>
                        <td>{{ d.device_code }}</td>
                        <td><div class="text-truncate" style="max-width: 260px;">{{ d.configuration }}</div></td>
                        <td>{{ d.created_at.strftime('%Y-%m-%d') if d.created_at else '' }}</td>
                        <td>{{ d.manager.full_name if d.manager else '' }}</td>
                        <td>{{ d.status }}</td>
                        <td><!-- Chạy dịch vụ: chưa có field, để trống --></td>
                        <td><!-- IP: chưa có field, để trống --></td>
                        <td>{{ d.notes }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const codeInput = document.getElementById('filter_code');
    const nameInput = document.getElementById('filter_name');
    const typeSelect = document.getElementById('filter_type');
    const selectEl = document.getElementById('devices_select');
    function applyFilter() {
        const code = (codeInput?.value || '').toLowerCase();
        const name = (nameInput?.value || '').toLowerCase();
        const type = (typeSelect?.value || '').toLowerCase();
        Array.from(selectEl.options).forEach(o => {
            const oc = (o.dataset.code || '').toLowerCase();
            const on = (o.dataset.name || '').toLowerCase();
            const ot = (o.dataset.type || '').toLowerCase();
            const match = (!code || oc.includes(code)) && (!name || on.includes(name)) && (!type || ot === type);
            o.hidden = !match;
        });
    }
    codeInput?.addEventListener('input', applyFilter);
    nameInput?.addEventListener('input', applyFilter);
    typeSelect?.addEventListener('change', applyFilter);
});
</script>
{% endblock %}

