{% extends "base.html" %}
{% block title %}Chi tiết báo lỗi: {{ bug_report.title }}{% endblock %}
{% block content %}
{% set codes = bug_report.device_code_list %}
<div class="mb-3">
  <a href="{{ url_for('bug_reports') }}" class="btn btn-sm btn-secondary">
    <i class="bi bi-arrow-left"></i> Quay lại
  </a>
  {% if is_creator or is_admin %}
  <a href="{{ url_for('edit_bug_report', report_id=bug_report.id) }}" class="btn btn-sm btn-primary">
    <i class="bi bi-pencil"></i> Sửa
  </a>
  {% endif %}
  {% if 'bug_reports.delete' in current_permissions %}
  <form method="POST" action="{{ url_for('delete_bug_report', report_id=bug_report.id) }}" class="d-inline" onsubmit="return confirm('Xóa báo lỗi này?')">
    <button class="btn btn-sm btn-danger" type="submit">
      <i class="bi bi-trash"></i> Xóa
    </button>
  </form>
  {% endif %}
  {% if can_close %}
  <form method="POST" action="{{ url_for('close_bug_report', report_id=bug_report.id) }}" class="d-inline ms-1" onsubmit="return confirm('Đóng vấn đề này?')">
    <button class="btn btn-sm btn-outline-success" type="submit">
      <i class="bi bi-check2-circle"></i> Đóng vấn đề
    </button>
  </form>
  {% endif %}
  {% if can_request_reopen %}
  <form method="POST" action="{{ url_for('request_reopen_bug_report', report_id=bug_report.id) }}" class="d-inline ms-1">
    <button class="btn btn-sm btn-outline-warning" type="submit">
      <i class="bi bi-arrow-repeat"></i> Yêu cầu mở lại
    </button>
  </form>
  {% endif %}
</div>

<div class="row g-3">
  <div class="col-md-8">
    <div class="card mb-3">
      <div class="card-header">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <h5 class="mb-0 text-break">{{ bug_report.title }}</h5>
          <div class="d-flex align-items-center gap-2 flex-wrap">
            {% if bug_report.priority == 'Khẩn cấp' %}
              <span class="badge bg-danger">{{ bug_report.priority }}</span>
            {% elif bug_report.priority == 'Cao' %}
              <span class="badge bg-warning">{{ bug_report.priority }}</span>
            {% elif bug_report.priority == 'Trung bình' %}
              <span class="badge bg-info">{{ bug_report.priority }}</span>
            {% else %}
              <span class="badge bg-secondary">{{ bug_report.priority }}</span>
            {% endif %}
            {% if bug_report.status == 'Mới tạo' %}
              <span class="badge bg-primary">{{ bug_report.status }}</span>
            {% elif bug_report.status == 'Đang xử lý' %}
              <span class="badge bg-warning">{{ bug_report.status }}</span>
            {% elif bug_report.status == 'Đã xử lý' %}
              <span class="badge bg-success">{{ bug_report.status }}</span>
            {% elif bug_report.status == 'Đã đóng' %}
              <span class="badge bg-secondary">{{ bug_report.status }}</span>
            {% else %}
              <span class="badge bg-light text-dark">{{ bug_report.status }}</span>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="card-body">
        {% if codes %}
        <div class="mb-3">
          <strong>Mã thiết bị:</strong>
          <div class="mt-2 d-flex flex-wrap gap-2">
            {% for code in codes %}
            <span class="me-1 text-body">{{ code }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        <div class="mb-3">
          <strong>Mô tả:</strong>
          <div class="mt-2" style="white-space: pre-wrap;">{{ bug_report.description }}</div>
        </div>
        
        {% if bug_report.attachments %}
        <div class="mb-3">
          <strong>File đính kèm:</strong>
          <ul class="list-unstyled mt-2">
            {% for att in bug_report.attachments %}
            <li>
              <i class="bi bi-paperclip"></i>
              <a href="{{ url_for('download_bug_report_file', report_id=bug_report.id, filename=att.file_name) }}" target="_blank">
                {{ att.file_name }}
              </a>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        <div class="row text-muted small">
          <div class="col-md-6">
            <strong>Người tạo:</strong> {{ bug_report.creator.full_name or bug_report.creator.username }}<br>
            <strong>Ngày tạo:</strong> {{ bug_report.created_at.strftime('%d-%m-%Y %H:%M') }}
          </div>
          <div class="col-md-6">
            {% if bug_report.assignee %}
            <strong>Người xử lý:</strong> {{ bug_report.assignee.full_name or bug_report.assignee.username }}<br>
            {% endif %}
            <strong>Cập nhật lần cuối:</strong> {{ bug_report.updated_at.strftime('%d-%m-%Y %H:%M') if bug_report.updated_at else '—' }}
          </div>
        </div>
      </div>
    </div>
    
    {% if 'bug_reports.edit' in current_permissions %}
    <div class="card mb-3">
      <div class="card-header"><strong>Cập nhật báo lỗi</strong></div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('update_bug_report', report_id=bug_report.id) }}">
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label class="form-label">Trạng thái</label>
              <select name="status" class="form-select">
                <option value="Mới tạo" {% if bug_report.status=='Mới tạo' %}selected{% endif %}>Mới tạo</option>
                <option value="Đang xử lý" {% if bug_report.status=='Đang xử lý' %}selected{% endif %}>Đang xử lý</option>
                <option value="Đã xử lý" {% if bug_report.status=='Đã xử lý' %}selected{% endif %}>Đã xử lý</option>
                <option value="Đã đóng" {% if bug_report.status=='Đã đóng' %}selected{% endif %}>Đã đóng</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Mức độ</label>
              <select name="priority" class="form-select">
                <option value="Thấp" {% if bug_report.priority=='Thấp' %}selected{% endif %}>Thấp</option>
                <option value="Trung bình" {% if bug_report.priority=='Trung bình' %}selected{% endif %}>Trung bình</option>
                <option value="Cao" {% if bug_report.priority=='Cao' %}selected{% endif %}>Cao</option>
                <option value="Khẩn cấp" {% if bug_report.priority=='Khẩn cấp' %}selected{% endif %}>Khẩn cấp</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Phạm vi</label>
              <select name="visibility" class="form-select">
                <option value="private" {% if bug_report.visibility=='private' %}selected{% endif %}>Cá nhân</option>
                <option value="public" {% if bug_report.visibility=='public' %}selected{% endif %}>Công khai</option>
              </select>
            </div>
          </div>
          {% if 'bug_reports.assign' in current_permissions and employees %}
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label">Người xử lý</label>
              <select name="assigned_to" id="assigned_to" class="form-select">
                <option value="">— Chưa gán —</option>
                {% for employee in employees %}
                <option value="{{ employee.id }}" {% if bug_report.assigned_to == employee.id %}selected{% endif %}>
                  {{ employee.full_name or employee.username }} ({{ employee.username }})
                </option>
                {% endfor %}
              </select>
            </div>
          </div>
          <script>
          $(document).ready(function() {
            $('#assigned_to').select2({
              width: '100%',
              placeholder: 'Tìm kiếm người xử lý...',
              allowClear: true
            });
          });
          </script>
          {% endif %}
          <div class="mb-3">
            <label class="form-label">Giải pháp/Ghi chú</label>
            <textarea name="resolution" class="form-control" rows="4" placeholder="Ghi chú về cách xử lý hoặc giải pháp...">{{ bug_report.resolution or '' }}</textarea>
          </div>
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-check-circle"></i> Cập nhật
          </button>
        </form>
      </div>
    </div>
    {% endif %}
    
    <div class="card mb-3">
      <div class="card-header"><strong>Bình luận</strong></div>
      <div class="card-body">
        {% for comment in bug_report.comments %}
        <div class="mb-3 pb-3 border-bottom">
          <div class="d-flex justify-content-between mb-2">
            <strong>{{ comment.creator.full_name or comment.creator.username }}</strong>
            <small class="text-muted">{{ comment.created_at.strftime('%d-%m-%Y %H:%M') }}</small>
          </div>
          <div style="white-space: pre-wrap;">{{ comment.comment }}</div>
        </div>
        {% else %}
        <p class="text-muted">Chưa có bình luận nào.</p>
        {% endfor %}
        
        {% if can_comment %}
        <form method="POST" action="{{ url_for('add_bug_report_comment', report_id=bug_report.id) }}" class="mt-3">
          <div class="mb-2">
            <textarea name="comment" class="form-control" rows="3" placeholder="Thêm bình luận..." required></textarea>
          </div>
          <button class="btn btn-sm btn-primary" type="submit">
            <i class="bi bi-chat"></i> Gửi bình luận
          </button>
        </form>
        {% else %}
        <div class="alert alert-secondary mt-3 mb-0">
          {% if bug_report.status == 'Đã đóng' %}
            Vấn đề đã được đóng. Vui lòng gửi yêu cầu mở lại nếu cần thêm trao đổi.
          {% else %}
            Bạn không có quyền bình luận báo lỗi này.
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
    
    {% if can_upload %}
    <div class="card">
      <div class="card-header"><strong>Tải file đính kèm</strong></div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('upload_bug_report_attachment', report_id=bug_report.id) }}" enctype="multipart/form-data">
          <input type="file" name="files" multiple class="form-control mb-2">
          <button class="btn btn-sm btn-outline-primary" type="submit">
            <i class="bi bi-upload"></i> Tải lên
          </button>
        </form>
      </div>
    </div>
    {% elif bug_report.status == 'Đã đóng' %}
    <div class="alert alert-secondary">
      Vấn đề đã đóng nên không thể tải thêm tệp đính kèm.
    </div>
    {% endif %}
  </div>
  
  <div class="col-md-4">
    <div class="card">
      <div class="card-header"><strong>Thông tin</strong></div>
      <div class="card-body">
        <div class="mb-2 d-flex align-items-center gap-2 flex-wrap">
          <strong>Trạng thái:</strong>
          {% if bug_report.status == 'Mới tạo' %}
            <span class="badge bg-primary">{{ bug_report.status }}</span>
          {% elif bug_report.status == 'Đang xử lý' %}
            <span class="badge bg-warning">{{ bug_report.status }}</span>
          {% elif bug_report.status == 'Đã xử lý' %}
            <span class="badge bg-success">{{ bug_report.status }}</span>
          {% elif bug_report.status == 'Đã đóng' %}
            <span class="badge bg-secondary">{{ bug_report.status }}</span>
          {% endif %}
        </div>
        <div class="mb-2 d-flex align-items-center gap-2 flex-wrap">
          <strong>Phạm vi:</strong>
          {% if bug_report.visibility == 'public' %}
            <i class="bi bi-globe" title="Công khai"></i> Công khai
          {% else %}
            <i class="bi bi-person" title="Cá nhân"></i> Cá nhân
          {% endif %}
        </div>
        <div class="mb-2 d-flex align-items-center gap-2 flex-wrap">
          <strong>Mức độ:</strong>
          {% if bug_report.priority == 'Khẩn cấp' %}
            <span class="badge bg-danger">{{ bug_report.priority }}</span>
          {% elif bug_report.priority == 'Cao' %}
            <span class="badge bg-warning">{{ bug_report.priority }}</span>
          {% elif bug_report.priority == 'Trung bình' %}
            <span class="badge bg-info">{{ bug_report.priority }}</span>
          {% else %}
            <span class="badge bg-secondary">{{ bug_report.priority }}</span>
          {% endif %}
        </div>
        <div class="mb-2">
          <strong>Người tạo:</strong><br>
          {{ bug_report.creator.full_name or bug_report.creator.username }}
        </div>
        {% if bug_report.assignee %}
        <div class="mb-2">
          <strong>Người xử lý:</strong>
          <span class="ms-1">{{ bug_report.assignee.full_name or bug_report.assignee.username }}</span>
        </div>
        {% endif %}
        {% if codes %}
        <div class="mb-2">
          <strong>Mã thiết bị:</strong>
          <div class="mt-1 d-flex flex-wrap gap-2">
            {% for code in codes %}
            <span class="me-1 text-body">{{ code }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        <div class="mb-2">
          <strong>Ngày tạo:</strong>
          <span class="ms-1">{{ bug_report.created_at.strftime('%d-%m-%Y %H:%M') }}</span>
        </div>
        {% if bug_report.resolved_at %}
        <div class="mb-2">
          <strong>Đã xử lý:</strong>
          <span class="ms-1">{{ bug_report.resolved_at.strftime('%d-%m-%Y %H:%M') }}</span>
        </div>
        {% endif %}
        {% if bug_report.resolution %}
        <div class="mb-2">
          <strong>Giải pháp:</strong>
          <div class="ms-1" style="white-space: pre-wrap; font-size: 0.9em;">{{ bug_report.resolution }}</div>
        </div>
        {% endif %}
        {% if bug_report.reopen_requested %}
        <div class="alert alert-warning">
          {% if is_admin %}
            Người tạo đã gửi yêu cầu mở lại vấn đề này.
          {% else %}
            Bạn đã yêu cầu mở lại. Vui lòng chờ quản trị viên xử lý.
          {% endif %}
        </div>
        {% endif %}
        {% if bug_report.status == 'Đã đóng' %}
        <div class="mb-2">
          <strong>Đánh giá:</strong><br>
          <div class="d-flex align-items-center gap-2">
            {% set rating = bug_report.rating or 5 %}
            <span class="text-warning fs-5">
              {% for _ in range(0, rating) %}★{% endfor %}
              {% for _ in range(rating, 5) %}☆{% endfor %}
            </span>
            <span class="text-muted">{{ rating }}/5</span>
          </div>
        </div>
        {% if can_rate %}
        <form method="POST" action="{{ url_for('rate_bug_report', report_id=bug_report.id) }}" class="d-flex align-items-center gap-2 mb-2">
          <select name="rating" class="form-select form-select-sm" style="max-width: 120px;">
            {% for value in range(5, 0, -1) %}
            <option value="{{ value }}" {% if bug_report.rating==value or (bug_report.rating is none and value==5) %}selected{% endif %}>{{ value }} sao</option>
            {% endfor %}
          </select>
          <button class="btn btn-sm btn-outline-primary" type="submit">Gửi</button>
        </form>
        {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

