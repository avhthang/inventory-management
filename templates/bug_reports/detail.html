{% extends "base.html" %}
{% block title %}Chi tiết báo lỗi: {{ bug_report.title }}{% endblock %}
{% block content %}
<div class="mb-3">
  <a href="{{ url_for('bug_reports') }}" class="btn btn-sm btn-secondary">
    <i class="bi bi-arrow-left"></i> Quay lại
  </a>
  {% if 'bug_reports.delete' in current_permissions %}
  <form method="POST" action="{{ url_for('delete_bug_report', report_id=bug_report.id) }}" class="d-inline" onsubmit="return confirm('Xóa báo lỗi này?')">
    <button class="btn btn-sm btn-danger" type="submit">
      <i class="bi bi-trash"></i> Xóa
    </button>
  </form>
  {% endif %}
</div>

<div class="row g-3">
  <div class="col-md-8">
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">{{ bug_report.title }}</h5>
        <div>
          {% if bug_report.priority == 'Khẩn cấp' %}
            <span class="badge bg-danger">{{ bug_report.priority }}</span>
          {% elif bug_report.priority == 'Cao' %}
            <span class="badge bg-warning">{{ bug_report.priority }}</span>
          {% elif bug_report.priority == 'Trung bình' %}
            <span class="badge bg-info">{{ bug_report.priority }}</span>
          {% else %}
            <span class="badge bg-secondary">{{ bug_report.priority }}</span>
          {% endif %}
          {% if bug_report.status == 'Mới tạo' %}
            <span class="badge bg-primary">{{ bug_report.status }}</span>
          {% elif bug_report.status == 'Đang xử lý' %}
            <span class="badge bg-warning">{{ bug_report.status }}</span>
          {% elif bug_report.status == 'Đã xử lý' %}
            <span class="badge bg-success">{{ bug_report.status }}</span>
          {% elif bug_report.status == 'Đã đóng' %}
            <span class="badge bg-secondary">{{ bug_report.status }}</span>
          {% else %}
            <span class="badge bg-light text-dark">{{ bug_report.status }}</span>
          {% endif %}
        </div>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <strong>Mô tả:</strong>
          <div class="mt-2" style="white-space: pre-wrap;">{{ bug_report.description }}</div>
        </div>
        
        {% if bug_report.attachments %}
        <div class="mb-3">
          <strong>File đính kèm:</strong>
          <ul class="list-unstyled mt-2">
            {% for att in bug_report.attachments %}
            <li>
              <i class="bi bi-paperclip"></i>
              <a href="{{ url_for('download_bug_report_file', report_id=bug_report.id, filename=att.file_name) }}" target="_blank">
                {{ att.file_name }}
              </a>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        <div class="row text-muted small">
          <div class="col-md-6">
            <strong>Người tạo:</strong> {{ bug_report.creator.full_name or bug_report.creator.username }}<br>
            <strong>Ngày tạo:</strong> {{ bug_report.created_at.strftime('%d-%m-%Y %H:%M') }}
          </div>
          <div class="col-md-6">
            {% if bug_report.assignee %}
            <strong>Người được gán:</strong> {{ bug_report.assignee.full_name or bug_report.assignee.username }}<br>
            {% endif %}
            <strong>Cập nhật lần cuối:</strong> {{ bug_report.updated_at.strftime('%d-%m-%Y %H:%M') if bug_report.updated_at else '—' }}
          </div>
        </div>
      </div>
    </div>
    
    {% if 'bug_reports.edit' in current_permissions %}
    <div class="card mb-3">
      <div class="card-header"><strong>Cập nhật báo lỗi</strong></div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('update_bug_report', report_id=bug_report.id) }}">
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label class="form-label">Trạng thái</label>
              <select name="status" class="form-select">
                <option value="Mới tạo" {% if bug_report.status=='Mới tạo' %}selected{% endif %}>Mới tạo</option>
                <option value="Đang xử lý" {% if bug_report.status=='Đang xử lý' %}selected{% endif %}>Đang xử lý</option>
                <option value="Đã xử lý" {% if bug_report.status=='Đã xử lý' %}selected{% endif %}>Đã xử lý</option>
                <option value="Đã đóng" {% if bug_report.status=='Đã đóng' %}selected{% endif %}>Đã đóng</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Mức độ</label>
              <select name="priority" class="form-select">
                <option value="Thấp" {% if bug_report.priority=='Thấp' %}selected{% endif %}>Thấp</option>
                <option value="Trung bình" {% if bug_report.priority=='Trung bình' %}selected{% endif %}>Trung bình</option>
                <option value="Cao" {% if bug_report.priority=='Cao' %}selected{% endif %}>Cao</option>
                <option value="Khẩn cấp" {% if bug_report.priority=='Khẩn cấp' %}selected{% endif %}>Khẩn cấp</option>
              </select>
            </div>
            {% if 'bug_reports.assign' in current_permissions and admins %}
            <div class="col-md-4">
              <label class="form-label">Gán cho</label>
              <select name="assigned_to" class="form-select">
                <option value="">— Chưa gán —</option>
                {% for admin in admins %}
                <option value="{{ admin.id }}" {% if bug_report.assigned_to == admin.id %}selected{% endif %}>
                  {{ admin.full_name or admin.username }}
                </option>
                {% endfor %}
              </select>
            </div>
            {% endif %}
          </div>
          <div class="mb-3">
            <label class="form-label">Giải pháp/Ghi chú</label>
            <textarea name="resolution" class="form-control" rows="4" placeholder="Ghi chú về cách xử lý hoặc giải pháp...">{{ bug_report.resolution or '' }}</textarea>
          </div>
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-check-circle"></i> Cập nhật
          </button>
        </form>
      </div>
    </div>
    {% endif %}
    
    <div class="card mb-3">
      <div class="card-header"><strong>Bình luận</strong></div>
      <div class="card-body">
        {% for comment in bug_report.comments %}
        <div class="mb-3 pb-3 border-bottom">
          <div class="d-flex justify-content-between mb-2">
            <strong>{{ comment.creator.full_name or comment.creator.username }}</strong>
            <small class="text-muted">{{ comment.created_at.strftime('%d-%m-%Y %H:%M') }}</small>
          </div>
          <div style="white-space: pre-wrap;">{{ comment.comment }}</div>
        </div>
        {% else %}
        <p class="text-muted">Chưa có bình luận nào.</p>
        {% endfor %}
        
        <form method="POST" action="{{ url_for('add_bug_report_comment', report_id=bug_report.id) }}" class="mt-3">
          <div class="mb-2">
            <textarea name="comment" class="form-control" rows="3" placeholder="Thêm bình luận..." required></textarea>
          </div>
          <button class="btn btn-sm btn-primary" type="submit">
            <i class="bi bi-chat"></i> Gửi bình luận
          </button>
        </form>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header"><strong>Tải file đính kèm</strong></div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('upload_bug_report_attachment', report_id=bug_report.id) }}" enctype="multipart/form-data">
          <input type="file" name="files" multiple class="form-control mb-2">
          <button class="btn btn-sm btn-outline-primary" type="submit">
            <i class="bi bi-upload"></i> Tải lên
          </button>
        </form>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card">
      <div class="card-header"><strong>Thông tin</strong></div>
      <div class="card-body">
        <div class="mb-2">
          <strong>Trạng thái:</strong><br>
          {% if bug_report.status == 'Mới tạo' %}
            <span class="badge bg-primary">{{ bug_report.status }}</span>
          {% elif bug_report.status == 'Đang xử lý' %}
            <span class="badge bg-warning">{{ bug_report.status }}</span>
          {% elif bug_report.status == 'Đã xử lý' %}
            <span class="badge bg-success">{{ bug_report.status }}</span>
          {% elif bug_report.status == 'Đã đóng' %}
            <span class="badge bg-secondary">{{ bug_report.status }}</span>
          {% endif %}
        </div>
        <div class="mb-2">
          <strong>Mức độ:</strong><br>
          {% if bug_report.priority == 'Khẩn cấp' %}
            <span class="badge bg-danger">{{ bug_report.priority }}</span>
          {% elif bug_report.priority == 'Cao' %}
            <span class="badge bg-warning">{{ bug_report.priority }}</span>
          {% elif bug_report.priority == 'Trung bình' %}
            <span class="badge bg-info">{{ bug_report.priority }}</span>
          {% else %}
            <span class="badge bg-secondary">{{ bug_report.priority }}</span>
          {% endif %}
        </div>
        <div class="mb-2">
          <strong>Người tạo:</strong><br>
          {{ bug_report.creator.full_name or bug_report.creator.username }}
        </div>
        {% if bug_report.assignee %}
        <div class="mb-2">
          <strong>Người được gán:</strong><br>
          {{ bug_report.assignee.full_name or bug_report.assignee.username }}
        </div>
        {% endif %}
        <div class="mb-2">
          <strong>Ngày tạo:</strong><br>
          {{ bug_report.created_at.strftime('%d-%m-%Y %H:%M') }}
        </div>
        {% if bug_report.resolved_at %}
        <div class="mb-2">
          <strong>Đã xử lý:</strong><br>
          {{ bug_report.resolved_at.strftime('%d-%m-%Y %H:%M') }}
        </div>
        {% endif %}
        {% if bug_report.resolution %}
        <div class="mb-2">
          <strong>Giải pháp:</strong><br>
          <div style="white-space: pre-wrap; font-size: 0.9em;">{{ bug_report.resolution }}</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

