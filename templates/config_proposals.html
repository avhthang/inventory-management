{% extends 'base.html' %}
{% block title %}Đề xuất cấu hình{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Đề xuất cấu hình thiết bị</h3>
  <a class="btn btn-primary" href="{{ url_for('add_config_proposal') }}"><i class="bi bi-plus-lg"></i> Tạo đề xuất</a>
</div>

<form class="row g-2 mb-3" method="get">
  <div class="col-md-7">
    <input type="text" class="form-control" name="name" placeholder="Tìm theo tên đề xuất"
      value="{{ filter_name or '' }}">
  </div>
  <div class="col-md-2">
    <input type="date" class="form-control" name="start_date" value="{{ start_date or '' }}">
  </div>
  <div class="col-md-2">
    <input type="date" class="form-control" name="end_date" value="{{ end_date or '' }}">
  </div>
  <div class="col-md-1 d-grid">
    <button class="btn btn-outline-secondary">Lọc</button>
  </div>
</form>

<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th class="text-center">#</th>
            <th class="text-center">Tên đề xuất</th>
            <th class="text-center">Ngày đề xuất</th>
            <th class="text-center" style="white-space: nowrap;">
              <strong>Người đề xuất</strong>
              <button type="button"
                class="btn btn-sm {% if filter_proposer %}btn-success text-white{% else %}btn-link{% endif %} p-0 ms-1"
                data-bs-toggle="dropdown" title="Lọc người đề xuất">
                <i class="bi bi-funnel"></i>
              </button>
              <ul class="dropdown-menu" style="max-height: 300px; overflow-y: auto;">
                <li><a class="dropdown-item" href="javascript:filterByParam('proposer', '')">Tất cả</a></li>
                {% for p in proposers %}
                <li><a class="dropdown-item" href="javascript:filterByParam('proposer', '{{ p }}')">{{ p }}</a></li>
                {% endfor %}
              </ul>
            </th>
            <th class="text-center" style="white-space: nowrap;">
              <strong>Đơn vị</strong>
              <button type="button"
                class="btn btn-sm {% if filter_unit %}btn-success text-white{% else %}btn-link{% endif %} p-0 ms-1"
                data-bs-toggle="dropdown" title="Lọc đơn vị">
                <i class="bi bi-funnel"></i>
              </button>
              <ul class="dropdown-menu" style="max-height: 300px; overflow-y: auto;">
                <li><a class="dropdown-item" href="javascript:filterByParam('unit', '')">Tất cả</a></li>
                {% for u in units %}
                <li><a class="dropdown-item" href="javascript:filterByParam('unit', '{{ u }}')">{{ u }}</a></li>
                {% endfor %}
              </ul>
            </th>
            <th class="text-center" style="white-space: nowrap;">
              <strong>Trạng thái</strong>
              <button type="button"
                class="btn btn-sm {% if filter_status %}btn-success text-white{% else %}btn-link{% endif %} p-0 ms-1"
                data-bs-toggle="dropdown" title="Lọc trạng thái">
                <i class="bi bi-funnel"></i>
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="javascript:filterByParam('status', '')">Tất cả</a></li>
                {% for s in statuses %}
                <li><a class="dropdown-item" href="javascript:filterByParam('status', '{{ s }}')">{{ s }}</a></li>
                {% endfor %}
              </ul>
            </th>
            <th class="text-center">Tổng</th>
            <th class="text-center">Thao tác</th>
          </tr>
        </thead>
        <tbody>
          {% for p in proposals.items %}
          <tr>
            <td class="text-start">{{ proposals.first + loop.index - 1 }}</td>
            <td class="text-start"><a href="{{ url_for('config_proposal_detail', proposal_id=p.id) }}"
                class="text-decoration-none fw-semibold">{{ p.name }}</a></td>
            <td class="text-start">{{ p.proposal_date.strftime('%d-%m-%Y') }}</td>
            <td class="text-start">{{ p.proposer_name or '' }}</td>
            <td class="text-start">{{ p.proposer_unit or '' }}</td>
            <td class="text-start">
              {% if p.status == 'new' %}<span class="badge bg-secondary">Mới tạo</span>
              {% elif p.status == 'team_approved' %}<span class="badge bg-info">Đã duyệt (BP)</span>
              {% elif p.status == 'it_consulted' %}<span class="badge bg-primary">Đã tư vấn (IT)</span>
              {% elif p.status == 'finance_reviewed' %}<span class="badge bg-warning text-dark">Đã duyệt (TC)</span>
              {% elif p.status == 'approved' %}<span class="badge bg-success">Đã duyệt (GĐ)</span>
              {% elif p.status == 'purchasing' %}<span class="badge bg-primary">Đang mua sắm</span>
              {% elif p.status == 'payment_done' %}<span class="badge bg-info">Đã thanh toán</span>
              {% elif p.status == 'goods_received' %}<span class="badge bg-info">Đã nhận hàng (IT)</span>
              {% elif p.status == 'handed_over' %}<span class="badge bg-success">Đã bàn giao</span>
              {% elif p.status == 'completed' %}<span class="badge bg-success">Hoàn tất</span>
              {% elif p.status == 'rejected' %}<span class="badge bg-danger">Đã từ chối</span>
              {% else %}<span class="badge bg-secondary">{{ p.status }}</span>{% endif %}
            </td>
            <td class="text-end text-nowrap">{{ (p.total_amount or 0)|vnd }} {{ p.currency }}</td>
            <td class="text-center">
              <div class="btn-group btn-group-sm" role="group">
                <a class="btn btn-outline-info" title="Xem"
                  href="{{ url_for('config_proposal_detail', proposal_id=p.id) }}"><i class="bi bi-eye"></i></a>

                {% set perms = current_permissions or [] %}
                {% if p.status in ['new', 'rejected'] or (p.status == 'team_approved' and ('config_proposals.consult_it'
                in perms or session['role'] == 'Admin')) %}
                <a class="btn btn-outline-warning ms-1" title="Sửa"
                  href="{{ url_for('edit_config_proposal', proposal_id=p.id) }}"><i class="bi bi-pencil"></i></a>
                {% endif %}

                <form method="post" action="{{ url_for('clone_config_proposal', proposal_id=p.id) }}"
                  class="d-inline m-0 p-0">
                  <button class="btn btn-outline-warning ms-1" title="Nhân bản"
                    onclick="return confirm('Nhân bản đề xuất này?')"><i class="bi bi-files"></i></button>
                </form>

                <!-- Only allow delete if new or rejected or admin -->
                <form method="post" action="{{ url_for('delete_config_proposal', proposal_id=p.id) }}"
                  class="d-inline m-0 p-0">
                  <button class="btn btn-outline-danger ms-1" title="Xóa"
                    onclick="return confirm('Xóa đề xuất này?')"><i class="bi bi-trash"></i></button>
                </form>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="10" class="text-center text-muted">Chưa có đề xuất nào.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% from '_pagination.html' import render_pagination %}
    {% set filters = {'name': filter_name, 'unit': filter_unit, 'proposer': filter_proposer, 'status': filter_status,
    'start_date': start_date, 'end_date': end_date} %}
    {{ render_pagination(proposals, 'config_proposals', filters) }}
  </div>
</div>

<script>
  function filterByParam(param, value) {
    const url = new URL(window.location.href);
    if (value) {
      url.searchParams.set(param, value);
    } else {
      url.searchParams.delete(param);
    }
    url.searchParams.set('page', 1);
    window.location.href = url.toString();
  }
</script>
{% endblock %}