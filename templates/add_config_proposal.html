{% extends 'base.html' %}
{% block title %}Tạo đề xuất cấu hình{% endblock %}
{% block content %}
<h3 class="mb-3">Tạo đề xuất cấu hình thiết bị</h3>

<form method="post">
  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <label class="form-label">Tên đề xuất</label>
      <input type="text" class="form-control" name="name" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Ngày đề xuất</label>
      <input type="date" class="form-control" name="proposal_date" value="{{ default_date }}" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Phạm vi</label>
      <select class="form-select" name="scope">
        <option value="Dùng chung">Dùng chung</option>
        <option value="Cá nhân">Cá nhân</option>
      </select>
    </div>
    <div class="col-md-6">
      <label class="form-label">Người đề xuất</label>
      <input type="text" class="form-control" name="proposer_name">
    </div>
    <div class="col-md-6">
      <label class="form-label">Đơn vị đề xuất</label>
      <input type="text" class="form-control" name="proposer_unit">
    </div>
    <div class="col-12">
      <label class="form-label">Ghi chú chung</label>
      <textarea class="form-control" rows="2" name="notes"></textarea>
    </div>
    <div class="col-md-3">
      <label class="form-label">Loại tiền</label>
      <select class="form-select" name="currency">
        <option value="VND" selected>VND</option>
        <option value="USD">USD</option>
        <option value="EURO">EURO</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">VAT (%)</label>
      <input type="number" class="form-control" name="vat_percent" id="vat_percent" step="0.01" value="10">
    </div>
    <div class="col-md-3">
      <label class="form-label">Trạng thái</label>
      <select class="form-select" name="status">
        <option value="Mới tạo" selected>Mới tạo</option>
        <option value="Lưu nháp">Lưu nháp</option>
        <option value="Đang xin ý kiến">Đang xin ý kiến</option>
        <option value="Đã xin ý kiến">Đã xin ý kiến</option>
        <option value="Đang mua hàng">Đang mua hàng</option>
        <option value="Hủy">Hủy</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Trạng thái mua hàng</label>
      <select class="form-select" name="purchase_status">
        <option value="Lấy báo giá" selected>Lấy báo giá</option>
        <option value="Chờ thanh toán">Chờ thanh toán</option>
        <option value="Chờ giao hàng">Chờ giao hàng</option>
        <option value="Chờ xuất hóa đơn">Chờ xuất hóa đơn</option>
        <option value="Đã hoàn thành">Đã hoàn thành</option>
      </select>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Chi tiết thiết bị</h5>
        <button type="button" id="btnAddRow" class="btn btn-sm btn-outline-primary"><i class="bi bi-plus-lg"></i> Thêm dòng</button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle" id="itemsTable">
          <thead class="table-light">
            <tr>
              <th style="width:70px">STT</th>
              <th>Tên sản phẩm</th>
              <th style="width:140px">Bảo hành</th>
              <th>Nhà cung cấp</th>
              <th style="width:120px">Số lượng</th>
              <th style="width:160px">Đơn giá</th>
              <th style="width:180px" class="text-end">Thành tiền</th>
              <th style="width:50px"></th>
            </tr>
          </thead>
          <tbody>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="6" class="text-end fw-semibold">Tổng tạm tính</td>
              <td class="text-end"><span id="subtotal">0</span></td>
              <td></td>
            </tr>
            <tr>
              <td colspan="6" class="text-end fw-semibold">Tiền VAT</td>
              <td class="text-end"><span id="vat_amount">0</span></td>
              <td></td>
            </tr>
            <tr>
              <td colspan="6" class="text-end fw-bold">Tổng cộng</td>
              <td class="text-end fw-bold"><span id="total_amount">0</span></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <input type="hidden" name="rows_count" id="rows_count" value="8">
  <button type="submit" class="btn btn-primary">Lưu đề xuất</button>
  <a href="{{ url_for('config_proposals') }}" class="btn btn-secondary">Hủy</a>
</form>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const tbody = document.querySelector('#itemsTable tbody');
  const rowsCountInput = document.getElementById('rows_count');
  const subtotalEl = document.getElementById('subtotal');
  const vatPercentEl = document.getElementById('vat_percent');
  const vatAmountEl = document.getElementById('vat_amount');
  const totalAmountEl = document.getElementById('total_amount');
  const addRowBtn = document.getElementById('btnAddRow');

  function fmt(n){
    const x = Number.isFinite(n) ? n : 0;
    return Math.round(x).toLocaleString('vi-VN');
  }
  function parseNum(v){
    const n = parseFloat(String(v).replace(/,/g, ''));
    return isNaN(n) ? 0 : n;
  }

  function recalc(){
    let subtotal = 0;
    tbody.querySelectorAll('tr').forEach(tr => {
      const qty = parseNum(tr.querySelector('.qty').value);
      const unit = parseNum(tr.querySelector('.unit').value);
      const line = Math.max(0, qty) * Math.max(0, unit);
      tr.querySelector('.line').textContent = fmt(line);
      subtotal += line;
    });
    subtotalEl.textContent = fmt(subtotal);
    const vatPercent = parseNum(vatPercentEl.value);
    const vatAmount = Math.round(subtotal * (vatPercent / 100));
    vatAmountEl.textContent = fmt(vatAmount);
    totalAmountEl.textContent = fmt(subtotal + vatAmount);
  }

  function newRow(idx){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="text-center">${idx+1}</td>
      <td><input name="rows[${idx}][product_name]" class="form-control"/></td>
      <td><input name="rows[${idx}][warranty]" class="form-control"/></td>
      <td><input name="rows[${idx}][supplier_info]" class="form-control"/></td>
      <td><input name="rows[${idx}][quantity]" type="number" min="0" class="form-control qty" value="0"/></td>
      <td><input name="rows[${idx}][unit_price]" type="number" min="0" step="0.01" class="form-control unit" value="0"/></td>
      <td class="text-end"><span class="line">0</span></td>
      <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger btn-remove">×</button></td>
    `;
    tbody.appendChild(tr);
  }

  function bind(){
    tbody.addEventListener('input', (e) => {
      if (e.target.matches('.qty, .unit')) recalc();
    });
    tbody.addEventListener('click', (e) => {
      if (e.target.closest('.btn-remove')){
        e.target.closest('tr').remove();
        // re-index
        const trs = [...tbody.querySelectorAll('tr')];
        trs.forEach((tr, i) => {
          tr.querySelector('td').textContent = i+1;
          const inputs = tr.querySelectorAll('input');
          inputs[0].name = `rows[${i}][product_name]`;
          inputs[1].name = `rows[${i}][warranty]`;
          inputs[2].name = `rows[${i}][supplier_info]`;
          inputs[3].name = `rows[${i}][quantity]`;
          inputs[4].name = `rows[${i}][unit_price]`;
        });
        rowsCountInput.value = trs.length;
        recalc();
      }
    });
    addRowBtn.addEventListener('click', () => {
      const idx = tbody.querySelectorAll('tr').length;
      newRow(idx);
      rowsCountInput.value = idx + 1;
    });
    vatPercentEl.addEventListener('input', recalc);
  }

  function init(){
    for (let i=0; i<8; i++) newRow(i);
    bind();
    recalc();
  }
  init();
})();
</script>
{% endblock %}

