{% extends "base.html" %}
{% block title %}Cấu hình Database{% endblock %}
{% block content %}
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="card-title mb-0">Cấu hình Database</h2>
            <a href="{{ url_for('backup_page') }}" class="btn btn-secondary">Quay lại</a>
        </div>
        
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>Lưu ý:</strong> Thay đổi cấu hình database sẽ chỉ có hiệu lực sau khi khởi động lại ứng dụng.
            Biến môi trường DATABASE_URL sẽ được ưu tiên hơn cấu hình này.
        </div>
        
        <div class="card mb-3">
            <div class="card-header">
                <h5>Thông tin Database hiện tại</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Loại database:</strong> {{ db_info.type|upper }}<br>
                        {% if db_info.type == 'sqlite' %}
                        <strong>File:</strong> {{ db_info.file }}<br>
                        {% else %}
                        <strong>Host:</strong> {{ db_info.host or '—' }}<br>
                        <strong>Port:</strong> {{ db_info.port or '—' }}<br>
                        <strong>Database:</strong> {{ db_info.database or '—' }}<br>
                        <strong>Username:</strong> {{ db_info.username or '—' }}<br>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <strong>Đường dẫn hiện tại:</strong><br>
                        <code style="word-break: break-all;">{{ current_db_url }}</code>
                    </div>
                </div>
            </div>
        </div>
        
        <form method="POST" action="{{ url_for('db_config_update') }}">
            <div class="card">
                <div class="card-header">
                    <h5>Cấu hình Database</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="database_url" class="form-label">Đường dẫn Database chính (Primary) <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="database_url" name="database_url" 
                               value="{{ custom_db_url or '' }}" 
                               placeholder="sqlite:///inventory.db hoặc postgresql://user:pass@host:port/dbname">
                        <small class="form-text text-muted">
                            Ví dụ:<br>
                            • SQLite: <code>sqlite:///inventory.db</code><br>
                            • PostgreSQL: <code>postgresql://username:password@hostname:5432/database_name</code><br>
                            • MySQL: <code>mysql+pymysql://username:password@hostname:3306/database_name</code>
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="secondary_database_url" class="form-label">Đường dẫn Database phụ (Secondary - HA) <span class="text-muted">(Tùy chọn)</span></label>
                        <input type="text" class="form-control" id="secondary_database_url" name="secondary_database_url" 
                               value="{{ secondary_db_url or '' }}" 
                               placeholder="postgresql://user:pass@host:port/dbname">
                        <small class="form-text text-muted">
                            Database phụ dùng cho High Availability (HA). Hệ thống sẽ tự động chuyển sang database phụ khi database chính gặp sự cố.<br>
                            <strong>Lưu ý:</strong> Database phụ phải có cùng schema và dữ liệu đồng bộ với database chính.
                        </small>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>High Availability (HA):</strong> Khi cấu hình database phụ, hệ thống sẽ tự động failover sang database phụ nếu database chính không khả dụng.
                        Để sử dụng cấu hình mặc định hoặc từ biến môi trường, để trống cả hai trường và nhấn "Lưu".
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Cảnh báo:</strong> Thay đổi đường dẫn database có thể khiến ứng dụng không thể kết nối đến database hiện tại.
                        Hãy đảm bảo bạn đã backup dữ liệu trước khi thay đổi.
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Lưu cấu hình
                </button>
                <a href="{{ url_for('backup_page') }}" class="btn btn-secondary ms-2">Hủy</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

